<%
  now = DateTime.now
  month_to_show = params[:month] ? DateTime.parse(params[:month]) : DateTime.new(now.year, now.month, 1)
%>
<% has_role = User.current.admin || User.current.roles_for_project(@project).include?(Role.find_by(:name => 'Jefe de proyecto')) || User.current.roles_for_project(@project).include?(Role.find_by(:name => 'Administrativo Facturacion')) %>
<!-- Importacion del archivo css -->
<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'facturation', :plugin => 'facturacion_proyecto', media: 'all' %>
<% end %>
<!-- Logo Folder IT -->
<h2>Facturaci&oacute;n de <%= @project %></h2>
<div class="facturation-folder-logo">
  <%= image_tag('folder-it-logo-header-blog.png', :plugin => 'facturacion_proyecto') %>
</div>
<!-- Comentarios -->
<div>
  <p class="comment"><span>Comentarios sobre la facturaci&oacute;n del proyecto:</span><br/>
    <br/>
    <textarea class="comment" id="facturation_comments" cols="100" rows="3"></textarea>
  </p>
  <br/>
</div>
<!-- Fecha -->
<div class="mes">
  <label for="month">Mes:</label>
  <select name="change_month" id="month">
    <% @months.each do |m| %>
      <option value="<%= DateTime.new(m.tyear, m.tmonth) %>"><%= m.month_name(m.tmonth) + '/' + m.tyear.to_s %></option>
    <% end %>
    <% if @months.where(:tmonth => now.month, :tyear => now.year).length < 1 %>
      <option value="<%= DateTime.new(now.year, now.month, 1) %>" selected><%= TimeEntry.month_name(now.month) + '/' + now.year.to_s %></option>
    <% end %>
  </select>
</div>
<br/>
<!-- Tabla facturacion -->
<div style="overflow-x:auto;">
  <table class="population">
    <tr>
      <th class="persona">Persona</th>
      <th>Rate Hora</th>
      <th>Horas trabajadas</th>
      <th>Comentarios</th>
      <th>Total ($)</th>
      <th>Editable</th>
      <th class="log">Log</th>
    </tr>
    <% for empleado in @project_active_members %>
      <tr class="data">
        <td class="table-user-name" id="table-user-name"><%= empleado.user %></td>
        <td class="table-hour-rate" id="table-hour-rate"><%= empleado.hour_rate %></td>
        <td class="table-horas-trabajadas" id="table-horas-trabajadas"></td>
        <td class="table-comment" id="table-comment"><%= empleado.comment %></td>
        <td class="table-total" id="table-total"><input class="input-total" type="number" name="total" readonly></td>
        <td class="table-checkbox" id="table-checkbox"><input type="checkbox" id="population"></td>
        <td class="table-log" id="table-log"><input class="input-log" type="text" name="logged-by" readonly></td>
      </tr>
    <% end %>
  </table>
</div>
<br/>
<!-- Other concepts -->
<div class="div_concepts">
  <span>
    <p class="p_concepts"> Otros gastos: </p>
    <input placeholder="Motivo" class="input_concepts" name="input_concepts">
    <input placeholder="Monto ($)" class="input_concepts_monto" name="input_concepts_monto" type="number">
  </span>
</div>
<br/>
<!-- Monto total -->
<div class="monto-total">
  <span class="span-monto-total">
    <button class="button_compute_total">Calcular Total</button>
    <button class="button_total" disabled>Total:</button>
    <input class="total_calculated" name="total_calculated" readonly>
  </span>
</div>
<br/>
<br/>
<div class="buttons-facturacion">
  <span>
    <button class="button-facturar">Facturar</button>
    <button class="button-guardar">Guardar</button>
    <button class="button-descargar-excel">Descargar como Excel</button>
  </span>
</div>
<script>
  $(document).ready(function (<% @project_active_members %>) {
  
    getHours();
    computeTableTotal();
  
    <% if has_role %>
      initMonthChange();
    <% end %>
  
  
    function initMonthChange() {
      var $month = $('#month');
      $month.val('<%=DateTime.new(month_to_show.year, month_to_show.month) %>');
      $month.bind('change', function () {
        window.location.replace(/month/.test(window.location.search) ? getModifiedHref($month) : (window.location.href + '&month=' + $month.val().slice(0, 10)));
      });
      $('#hidden-month').text($month.children(":selected").text());
    }
  
    function getModifiedHref($month) {
      var currentLocation = window.location.href;
      var n = currentLocation.indexOf("month=");
      var i = currentLocation.indexOf("&project");
      if(i>n){
        return currentLocation.replace(currentLocation.substr(n, (i-n)), "month=" + $month.val().slice(0, 10));
      }else{
        return window.location.href.slice(0, -17) + '&month=' + $month.val().slice(0, 10);
      }
    }
  
  
  
    function getHours () {
      var all_rows = $('.data');
      employees_hours = [];
      <% fecha = params[:month] ? DateTime.parse(params[:month]) : DateTime.new(DateTime.now.year, DateTime.now.month, 1) %>
  
      <% @project_active_members.each do |empleado| %>
        <% hours = 0.0 %>
        <% hours = TimeEntry.where(user_id: empleado.user_id, project_id: empleado.project_id, tmonth: fecha.month, tyear: fecha.year).sum(&:hours) %>
        employees_hours.push('<%= hours %>');
      <% end %>
  
      var index = 0;
      all_rows.each(function () {
        $(this).find('#table-horas-trabajadas').text(employees_hours[index]);
        index++;
      });
    }
  
    function computeTableTotal() {
      var all_rows = $('.data');
  
      all_rows.each(function () {
        var rate_data = $(this).find('#table-hour-rate');
        var worked_hours_data = $(this).find('#table-horas-trabajadas');
  
        var rate = parseFloat(rate_data.text());
        var hours = parseInt(worked_hours_data.text());
  
        $(this).find('.input-total').attr('value', rate*hours);
      });
    }
  });
</script>
<script type="text/javascript">
  $('table tr').click( function() {
    var tr = $(this).closest('tr');
    var check = $(this).find('input[type=checkbox]');
  
    if (check.is(":checked")){
      tr.find(".input-total").removeAttr("readonly");
      tr.find(".input-log").removeAttr("readonly");
      tr.find(".input-total").css('background-color', 'white');
      tr.find(".input-total").css('border-color', '#dddddd');
      tr.find(".input-log").css('background-color', 'white');
      tr.find(".input-log").css('border-color', '#dddddd');
    } else {
      tr.find(".input-total").attr("readonly", true);
      tr.find(".input-log").attr("readonly", true);
      tr.find(".input-total").css('background-color', 'transparent');
      tr.find(".input-total").css('border', 'none');
      tr.find(".input-log").css('background-color', 'transparent');
      tr.find(".input-log").css('border', 'none');
    }
  });
</script>
<script type="text/javascript">
  $(document).find('.button_total').hide();
  $(document).find('.total_calculated').hide();
  
  $(document).on('click', '.button_compute_total', function computeTotal() {
    $(document).find('.button_total').show();
    $(document).find('.total_calculated').show();
  
    var all_rows = $('.data');
    var total = 0.0;
  
    all_rows.each(function () {
      var input_total = $(this).find('.input-total');
      var value = input_total.val();
      total += parseFloat(value);
    })
  
    var other_concepts = $(document).find('.input_concepts_monto');
    var other_concepts_monto = other_concepts.val();
    if (other_concepts_monto.length != 0) {
      total += parseFloat(other_concepts_monto);
    }
  
    $(document).find('.total_calculated').attr('value', total);
  
  
  
  
    $('input[name=total]').change(function() {
      var tr = $(this).closest('tr');
      var check = tr.find('input[type=checkbox]');
  
      if (check.is(":checked")){
        var table_input_total = tr.find('.input-total');
        var input_value = table_input_total.val();
        total += parseFloat(input_value);
      }
  
      $(document).find('.total_calculated').val(total);
    });
  
  
    $('input[name=input_concepts_monto]').change(function() {
      var other_concepts = $(document).find('.input_concepts_monto');
      var other_concepts_monto = other_concepts.val();
  
      if (other_concepts_monto.length != 0) {
        total += parseFloat(other_concepts_monto);
      }
  
      $(document).find('.total_calculated').val(total);
    });
  });
  
  
  
  //TODO en un futuro cercano
  $(document).on('click', '.button-facturar', function () {
  
  });
  
  $(document).on('click', '.button-guardar', function () {
  
  });
  
  $(document).on('click', '.button-descargar-excel', function () {
  
  });
</script>
